<!doctype html>
<html lang="en">

<head>
  <!-- Required meta tags -->
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <title>Checkout</title>
  <link rel="shortcut icon" href="/img/Cat & Dog 3a.png">

  <!-- Bootstrap CSS -->
  <link rel="stylesheet" href="/assets/productcss/bootstrap.min.css">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@10"></script>

  <!-- Font Awesome CSS -->
  <link rel="stylesheet" href="/assets/productcss/all.css">

  <!-- Flaticon and Themify Icons CSS -->
  <link rel="stylesheet" href="/assets/productcss/flaticon.css">
  <link rel="stylesheet" href="/assets/productcss/themify-icons.css">

  <!-- Magnific Popup CSS -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/magnific-popup.js/1.1.0/magnific-popup.min.css">
  <link rel="stylesheet" href="/assets/productcss/magnific-popup.css">

  <!-- Owl Carousel CSS -->
  <link rel="stylesheet" href="/assets/productcss/owl.carousel.min.css">

  <!-- Nice Select CSS -->
  <link rel="stylesheet" href="/assets/productcss/nice-select.css">

  <!-- Slick CSS -->
  <link rel="stylesheet" href="/assets/productcss/slick.css">

  <!-- Swiper CSS -->
  <link rel="stylesheet" href="/assets/productcss/animate.css">

  <!-- Price Ranges CSS -->
  <link rel="stylesheet" href="/assets/productcss/price_rangs.css">

  <!-- Custom Style CSS -->
  <link rel="stylesheet" href="/assets/productcss/style.css">

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.0.0/animate.compat.css" />
  <style>
    body {
      font-family: Arial, sans-serif;
    }

    .popup {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100dvw;
      height: 100dvh;
      background-color: rgba(0, 0, 0, 0.5);
    }

    .popup-content {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background-color: rgb(235, 229, 229);
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
    }

    .close {
      position: absolute;
      top: 10px;
      right: 10px;
      font-size: 40px;
      cursor: pointer;
    }

    .horizontal-form {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
    }

    .form-group {
      display: flex;
      flex-direction: column;
    }

    .form-label {
      margin-bottom: 5px;
    }

    .form-control {
      padding: 8px;
      margin-bottom: 10px;
    }

    button {
      grid-column: span 2;
      /* Make the button span two columns */
      padding: 10px;
      background-color: #4caf50;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }

    body {
      font-family: Arial, sans-serif;
      margin: 0;
      /* Reset default body margin */
    }

    .btn_3 {
      padding: 10px;
      background-color: #4caf50;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      margin: 20px 0;
      /* Add margin top and bottom */
    }

    /* Responsive margin adjustments */
    @media screen and (max-width: 600px) {
      .btn_1 {
        margin: 10px 0;
        /* Adjust margin for smaller screens */
      }
    }
  </style>
</head>

<body style="position: relative; z-index: 1;">
  <%- include('../partials/layoutpage.ejs') %>
    <!--::header part start::-->
    <%- include('../partials/userpartials/header.ejs') %>
      <!-- Header part end-->

      <!--================Home Banner Area =================-->
      <!-- breadcrumb start-->
      <section class="breadcrumb breadcrumb_bg">
        <div class="container">
          <div class="row justify-content-center">
            <div class="hero">
              <div class="container">
                <div class="row justify-content-between">
                  <div class="col-lg-5">
                    <div class="intro-excerpt">
                      <h1>Checkout </h1>
                    </div>
                  </div>
                  <div class="col-lg-7">
                    <p>"Pets are humanizing. They remind us we have an obligation and responsibility to preserve and
                      nurture and care for all life. Money can buy you a fine dog, but only love can make him wag
                      his tail. The trouble with a kitten is that eventually it becomes a cat."</p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>
      <!-- breadcrumb start-->

      <!--================Checkout Area =================-->
      <section class="checkout_area ">
        <button class="btn_3" style="margin-left: 60px;" onclick="openPopup()">ADD New Address</button>
        <div class="container">
          <div class="popup" id="popup" style="position: fixed; z-index: 10;">
            <div class="popup-content">
              <span class="close" onclick="closePopup()">&times;</span>
              <h2>Add New Address</h2>
              <form id="addressForm" action="/checkoutaddress" class="horizontal-form" method="POST"
                onsubmit="return validateForm()">
                <div class="form-group">
                  <label for="name" class="form-label">Name:</label>
                  <input type="text" class="form-control" id="name" name="name" required>
                  <div id="nameError" class="error-message"></div>
                </div>

                <div class="form-group">
                  <label for="homeaddress" class="form-label">Address:</label>
                  <input type="text" class="form-control" id="homeaddress" name="homeaddress" required>
                  <div id="homeaddressError" class="error-message"></div>
                </div>

                <div class="form-group">
                  <label for="district" class="form-label">District:</label>
                  <input type="text" class="form-control" id="district" name="district" required>
                  <div id="districtError" class="error-message"></div>
                </div>

                <div class="form-group">
                  <label for="pincode" class="form-label">Pincode:</label>
                  <input type="number" class="form-control" id="pincode" name="pincode" required>
                  <div id="pincodeError" class="error-message"></div>
                </div>

                <div class="form-group">
                  <label for="phone" class="form-label">Phone:</label>
                  <input type="number" class="form-control" id="phone" name="phone" required>
                  <div id="phoneError" class="error-message"></div>
                </div>

                <div class="form-group">
                  <label for="email" class="form-label">E-mail:</label>
                  <input type="email" class="form-control" id="email" name="email" required>
                  <div id="emailError" class="error-message"></div>
                </div>

                <div class="form-group">
                  <label for="state" class="form-label">State:</label>
                  <input type="text" class="form-control" id="state" name="state" required>
                  <div id="stateError" class="error-message"></div>
                </div>

                <button type="submit">Submit</button>
              </form>
            </div>
          </div>

          <div class="billing_details">
            <div class="row">

              <div class="col-lg-8 ">

                <h2>Billing Details</h2>
                <p id="address" data-address="<%= addressdetails.id %>"></p>
                <% addressdetails.forEach((row,index)=> {%>
                  <input type="radio" id="deliveryaddresss" name="deliveryaddresss" checked
                    value="<%=row.id%>" /><span>Select Address</span>
                  <address>



                    <h5>
                      <%=row.name%>
                    </h5>
                    <h6>
                      <%=row.address%>
                    </h6>
                    <h6>Ph :- <%=row.phone%>
                    </h6>
                    <h6>Mail :- <%=row.email%>
                    </h6>
                    <h6>Pin :-<%=row.pincode%>
                    </h6>
                    <h6>City :-<%=row.district%>
                    </h6>
                    <h6>State :-<%=row.state%>
                    </h6>
                    <h4>
                      <button onclick="removeAddress('<%= row.id %>')" class="btn_1"
                        style="margin-left: 0%;">Remove</button>
                    </h4>
                    <br>
                  </address>

                  <% }); %>
              </div>








              <div class="col-lg-4">
                <div class="order_box">
                  <h2>Your Order</h2>
                  <ul>
                    <li class="mt-3">
                      <div class="d-flex align-items-center">
                        <input type="text" id="couponCode" class="form-control me-2" placeholder="Enter coupon code">
                      </div>
                      <div class="text-end">
                        <button id="applyButton" class="btn btn-primary" onclick="applyCoupon()">Apply</button>

                      </div>
                    </li>
                  </ul>
                  <ul class="list">
                    <li>
                      <a style="font-weight: bold;color: black;" href="/cart">Product
                        <span style="font-weight: bold; color: black;">Total</span>
                      </a>
                    </li>

                    <% let subtotal=0 %>
                      <% if (cartdetails !==null) { %>

                        <% cartdetails.products.forEach((prod, index)=> { %>
                          <% let product=productdetails.find(item=> item._id.equals(prod.productId)); %>
                            <p id="productDetails" data-product="<%= product %>"></p>
                            <li class="your-product-selector">
                              <a href="#" class="product-name">

                                <p class="product-id" style="display: none;">
                                  <%=product.id%>
                                </p>
                                <%= product.name %>
                                  <% const uniquepricetotal=Number(product.price) * Number(prod.quantity)%>
                                    <span class="uniquetotalprice">
                                      <%=uniquepricetotal%>
                                    </span>
                                    <span style="margin-right: 65px;font-weight: bold; color: black;" class="quantity">
                                      X<%= prod.quantity %>
                                    </span>
                                    <% subtotal +=uniquepricetotal %>
                              </a>
                            </li>
                            <% }); %>


                              <% } else { %>
                                <tr>
                                  <td colspan="5">
                                    <img style="width: 400px; height: 300px; color: red;" src="/img/empty-cart.png"
                                      alt="image">
                                    " YOUR CART IS EMPTY " Pls add product to use cart feature
                                  </td>
                                </tr>
                                <% } %>

                  </ul>
                  <ul class="list list_2">
                    <li>
                      <a href="#">Subtotal


                        <span id="subtotal" style="font-weight: bold; color: black;">
                          <%=subtotal%>
                        </span>
                      </a>
                    </li>
                    <li>
                      <a href="#">Shipping
                        <span>RS: 40</span>
                      </a>
                    </li>
                    <li>
                      <% total=subtotal+40 %>
                        <a href="#">Total
                          <span id="totalprice" style="font-weight: bold; color: black;">
                            <%=total %>
                          </span>
                        </a>
                    <li>
                      <h4 id="animation" style="font-weight: bold; color: red;"></h4>
                    </li>
                    <br>
                    <li>
                      <p id="walletamount" hidden>
                        <%=wallet %>
                      </p>
                      <a href="#" style="font-weight: bold;">Wallet Amount
                        <span style="font-weight: bold; color: rgb(239, 0, 0);">
                          <%=wallet %>
                        </span>
                      </a>
                    </li>
                    <br>
                  </ul>
                  <form action="" id="payment">
                    <div class="payment_item">
                      <div class="radion_btn">
                        <input type="radio" id="cod" name="selector" value="COD" checked />
                        <label for="cod">Cash On Delivery</label>
                        <div class="check"></div>
                      </div>


                      <div class="radion_btn">
                        <div id="payNowButton">
                          <input type="radio" id="online" name="selector" value="online" />
                          <label for="online">Online</label>
                          <div class="check"></div>
                        </div>
                      </div>

                      <div class="radion_btn">
                        <div id="walletButton">
                          <input type="radio" id="wallet" name="selector" value="wallet" />
                          <label for="wallet">Pay on Wallet</label>
                          <div class="check"></div>
                        </div>
                      </div>

                  </form>
                </div>
              </div>

              <button class="btn_3" id="rzp-button1" onclick="confirmOrder()">Confirm Order</button>
            </div>
          </div>
        </div>
        </div>
        </div>
      </section>
      <!--================End Checkout Area =================-->



      <!--::footer_part start::-->
      <%- include('../partials/userpartials/footer.ejs') %>
        <!--::footer_part end::-->








        <!-- jquery plugins here-->

        <!-- jQuery -->
        <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>

        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" />

        <!-- Bootstrap and Popper.js -->
        <script src="/singlejs/popper.min.js"></script>
        <script src="/singlejs/bootstrap.min.js"></script>

        <!-- Magnific Popup -->
        <script
          src="https://cdnjs.cloudflare.com/ajax/libs/magnific-popup.js/1.1.0/jquery.magnific-popup.min.js"></script>
        <script src="/singlejs/jquery.magnific-popup.js"></script>

        <!-- Swiper JS -->
        <script src="/singlejs/swiper.min.js"></script>

        <!-- Masonry -->
        <script src="/singlejs/masonry.pkgd.js"></script>

        <!-- Particles JS -->
        <script src="/singlejs/owl.carousel.min.js"></script>
        <script src="/singlejs/jquery.nice-select.min.js"></script>

        <!-- Slick JS -->
        <script src="/singlejs/slick.min.js"></script>

        <!-- Counterup and Waypoints -->
        <script src="/singlejs/jquery.counterup.min.js"></script>
        <script src="/singlejs/waypoints.min.js"></script>

        <!-- Contact and Form Scripts -->
        <script src="/singlejs/contact.js"></script>
        <script src="/singlejs/jquery.ajaxchimp.min.js"></script>
        <script src="/singlejs/jquery.form.js"></script>
        <script src="/singlejs/jquery.validate.min.js"></script>
        <script src="/singlejs/mail-script.js"></script>
        <!-- razorpay -->
        <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
        <script src="/singlejs/price_rangs.js"></script>
        <script src="/singlejs/custom.js"></script>

        <script>
          var addressid;
          const totalprice = document.getElementById('totalprice').innerText
          let onlinePay = function (e) {
            fetch('/razorpay', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify({
                'amount': totalprice,
              }),
            })
              .then(response => response.json())

              .then(data => {

                if (data.success) {
                
                const orderId = data.orderId;
                console.log("OrderId received:", orderId);


                let paymentMode = document.getElementById('payment').selector.value
                const addressdetails = document.getElementById('address')
                const addressdata = addressdetails.getAttribute('data-address')
                var options = {
                  "key": "rzp_test_YqIuT5ZP4j00kQ", // Enter the Key ID generated from the Dashboard
                  "amount": Number(totalprice) * 100, // Amount is in currency subunits. Default currency is INR. Hence, 50000 refers to 50000 paise
                  "currency": "INR",
                  "name": "Petstation", //your business name
                  "description": "Test Transaction",
                  "image": "/img/aksharalogo.png",
                  "order_id": orderId, //This is a sample Order ID. Pass the `id` obtained in the response of Step 1
                  "callback_url": "/confirmation",
                  // "prefill": { //We recommend using the prefill parameter to auto-fill customer's contact information especially their phone number
                  //   "name": "Gaurav Kumar", //your customer's name
                  //   "email": "gaurav.kumar@example.com",
                  //   "contact": "7902371571" //Provide the customer's phone number for better conversion rates 
                  // },
                  "notes": {
                    "payment": paymentMode,
                    "address": addressid
                  },
                  "theme": {
                    "color": "#3399cc"
                  }
                };
                var rzp1 = new Razorpay(options);
                rzp1.open();
                e.preventDefault();

            
            } else {
                    // Show animated warning using SweetAlert2
                    Swal.fire({
                      icon: 'warning',
                      title: 'Address Not Found',
                      text: 'Please provide a valid address.',
                      confirmButtonText: 'OK',
                      timer: 3000, // Automatically close after 5 seconds
                    });
                  }
                })
              .catch(error => console.error('Error:', error));
          };
        </script>

        <script>
          function applyCoupon() {
            const couponCode = document.getElementById('couponCode').value;
            const getsubtotal = document.getElementById('subtotal').innerText;
            const totalprice = document.getElementById('totalprice').innerText;
            const applyCouponBtn = document.getElementById('applyCouponBtn');
            fetch(`/couponapply/${couponCode}`, {
              method: 'POST',
              headers: { 'content-Type': 'application/json' },
              body: JSON.stringify({
                subtotal: getsubtotal,
                couponCode: couponCode
              })
            })
              .then(response => {
                if (response.ok) {
                  return response.json();
                } else {
                  throw new Error('Network response was not ok');
                }
              })
              .then(data => {
                console.log(data);
                if (data.type == 'Fixed Amount') {
                  let subtotal = getsubtotal - data.value;
                  document.getElementById('subtotal').innerText = subtotal;
                  document.getElementById('totalprice').innerText = subtotal + 40;
                } else {
                  document.getElementById('totalprice').innerText = (subtotal * data.value / 100);
                }
                if (data.message) {
                  document.getElementById('animation').innerText = data.message
                  document.getElementById('rzp-button1').disabled = true;

                } else {
                  Swal.fire({
                    position: "top-end",
                    icon: "success",
                    title: "Your Coupon Added successfully",
                    showConfirmButton: false,
                    timer: 2000
                  });
                }

                // Disable the button after a successful fetch
                document.getElementById('applyButton').disabled = true;
              })
              .catch(error => {
                console.error('Fetch error:', error);

                // Enable the button in case of an error
                document.getElementById('applyButton').disabled = true;
              });
          }
        </script>





        <!-- opening popup for address add -->
        <script>
          function openPopup() {
            document.getElementById('popup').style.display = 'block';
          }
          function closePopup() {
            document.getElementById('popup').style.display = 'none';
          } 
        </script>

        <script>
          // addressid = document.getElementById('addressid').innerText
          addressid = document.querySelector('input[name="deliveryaddresss"]:checked').value
          var radioButtons = document.querySelectorAll('input[type="radio"]');
          radioButtons.forEach(radioButton => {
            radioButton.addEventListener('change', function () {
              addressid = document.querySelector('input[name="deliveryaddresss"]:checked').value;

            });
          });

          function confirmOrder() {
            // console.log("worked");
            let paymentMode = document.getElementById('payment').selector.value
            if (paymentMode == "COD") {


              const orderDetails = [];
              document.querySelectorAll('.your-product-selector').forEach(item => {
                const productId = item.querySelector('.product-id').innerText.trim()
                const quantity = item.querySelector('.quantity').innerText.split('X')[1].trim();
                const uniquePriceTotal = item.querySelector('.uniquetotalprice').innerText.trim();
                // const addressid = document.getElementById('addressid').innerText
                const paymentMode = document.getElementById('payment').selector.value


                orderDetails.push({
                  productId,
                  quantity,
                  uniquePriceTotal,
                });
              });


              fetch('/confirmation', {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                  addressid,
                  orderDetails,
                  paymentMode
                }),
              })
                .then(response => response.json())
                .then(data => {
                  if (data.success) {
                    // Redirect to confirmation page on success
                    window.location.href = '/confirmation';
                  } else {
                    // Show animated warning using SweetAlert2
                    Swal.fire({
                      icon: 'warning',
                      title: 'Address Not Found',
                      text: 'Please provide a valid address.',
                      confirmButtonText: 'OK',
                      timer: 3000, // Automatically close after 5 seconds
                    });
                  }
                })
                .catch(error => {
                  console.error('Error:', error);
                });
            } else if (paymentMode == "wallet") {
              const orderDetails = [];
              document.querySelectorAll('.your-product-selector').forEach(item => {
                const productId = item.querySelector('.product-id').innerText.trim()
                const quantity = item.querySelector('.quantity').innerText.split('X')[1].trim();
                const uniquePriceTotal = item.querySelector('.uniquetotalprice').innerText.trim();
                const paymentMode = document.getElementById('payment').selector.value
                const walletElement = document.getElementById('walletamount');
                const walletAmount = walletElement.innerText.trim();
                orderDetails.push({
                  productId,
                  quantity,
                  uniquePriceTotal,
                  walletAmount
                });
              });
              fetch('/walletorder', {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                  addressid,
                  orderDetails,
                  paymentMode,

                }),
              })
                .then(response => response.json())
                .then(data => {
                  if (data.error) {
                    Swal.fire({
                      icon: 'warning',
                      title: 'Insufficient Wallet Balance',
                      text: 'Your wallet balance is not sufficient to place this order.',
                    });
                  } else if (!data.success) {
                    // Show animated warning using SweetAlert2
                    Swal.fire({
                      icon: 'warning',
                      title: 'Address Not Found',
                      text: 'Please provide a valid address.',
                      confirmButtonText: 'OK',
                      timer: 3000, // Automatically close after 5 seconds
                    });
                  } else {
                    window.location.href = '/confirmation';

                  }
                })
                .catch(error => {
                  console.error('Error:', error);
                });
            } else {
              onlinePay(event)
            }
          }
        </script>

        <!-- remove-address -->
        <script>
          function removeAddress(addressId) {
            fetch(`/remove-address/${addressId}`, {
              method: 'DELETE',
              headers: {
                'Content-Type': 'application/json',
              },
            })
              .then(response => {
                if (!response.ok) {
                  throw new Error(`HTTP error! Status: ${response.status}`);
                }
                return response.json();
              })
              .then(data => {
                windows.location.href('/signup')
                console.log('Address removed:', data);
              })
              .catch(error => {
                console.error('Error removing address:', error);
              });
          }
        </script>

        <!-- form validation -->
        <script>
          function validateForm() {
            var name = document.getElementById("name").value;
            var homeaddress = document.getElementById("homeaddress").value;
            var district = document.getElementById("district").value;
            var pincode = document.getElementById("pincode").value;
            var phone = document.getElementById("phone").value;
            var email = document.getElementById("email").value;
            var state = document.getElementById("state").value;

            document.getElementById("nameError").innerHTML = "";
            document.getElementById("homeaddressError").innerHTML = "";
            document.getElementById("districtError").innerHTML = "";
            document.getElementById("pincodeError").innerHTML = "";
            document.getElementById("phoneError").innerHTML = "";
            document.getElementById("emailError").innerHTML = "";
            document.getElementById("stateError").innerHTML = "";

            // Validate name (only letters and spaces)
            var nameRegex = /^[a-zA-Z ]+$/;
            if (!nameRegex.test(name)) {
              document.getElementById("nameError").innerHTML = "Name should only contain letters and spaces.";
              return false;
            }

            // Validate address (optional: letters, numbers, and spaces)
            var addressRegex = /^[a-zA-Z0-9 ]*$/;
            if (!addressRegex.test(homeaddress)) {
              document.getElementById("homeaddressError").innerHTML = "Address should only contain letters, numbers, and spaces.";
              return false;
            }

            // Validate district (only letters)
            var districtRegex = /^[a-zA-Z]+$/;
            if (!districtRegex.test(district)) {
              document.getElementById("districtError").innerHTML = "District should only contain letters.";
              return false;
            }

            // Validate pincode (5-digit number)
            var pincodeRegex = /^\d{5}$/;
            if (!pincodeRegex.test(pincode)) {
              document.getElementById("pincodeError").innerHTML = "Pincode should be a 5-digit number.";
              return false;
            }

            // Validate phone (10-digit number)
            var phoneRegex = /^\d{10}$/;
            if (!phoneRegex.test(phone)) {
              document.getElementById("phoneError").innerHTML = "Phone should be a 10-digit number.";
              return false;
            }

            // Validate email
            var emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
              document.getElementById("emailError").innerHTML = "Invalid email address.";
              return false;
            }

            // Validate state (only letters)
            var stateRegex = /^[a-zA-Z]+$/;
            if (!stateRegex.test(state)) {
              document.getElementById("stateError").innerHTML = "State should only contain letters.";
              return false;
            }

            return true;
          }
        </script>
</body>

</html>